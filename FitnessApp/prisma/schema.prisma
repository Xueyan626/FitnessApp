// prisma/schema.prisma
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id        String    @id @default(cuid())
  email     String    @unique
  passwordHash String?
  name      String?
  role Role @default(USER)
  coachStatus CoachStatus? // Only for COACH role
  heightCm  Int?
  weightKg  Int?
  sex       String?
  birthDate DateTime?
  points    Int       @default(0)
  bronzeBadges Int    @default(0)
  silverBadges Int    @default(0)
  goldBadges   Int    @default(0)
  createdAt DateTime  @default(now())

  assessments   Assessment[]
  postures      PostureAnalysis[]
  plans         Plan[]
  todos         Todo[]
  weeklyReports WeeklyReport[]
  rewards       Reward[]
  
  // Coach-related relations
  coachReports   CoachReport[] @relation("CoachReports")
  studentReports CoachReport[] @relation("StudentReports")
  coachStudents  CoachStudent[] @relation("CoachStudents")
  studentCoaches CoachStudent[] @relation("StudentCoaches")
}

model Assessment {
  id           String        @id @default(cuid())
  userId       String
  constitution Constitution?
  answers      Json?
  scores       Json?
  questionnaireVersion Int   @default(1)
  createdAt    DateTime      @default(now())

  user  User   @relation(fields: [userId], references: [id])
  plans Plan[]

  @@index([userId, createdAt])
}

model PostureAnalysis {
  id         String   @id @default(cuid())
  userId     String
  frontUrl   String?
  sideUrl    String?
  backUrl    String?
  analysisMd String?
  createdAt  DateTime @default(now())

  // relations
  user  User   @relation(fields: [userId], references: [id])
  plans Plan[] // 1 PostureAnalysis -> many Plans (optional on Plan)
}

model Plan {
  id                String   @id @default(cuid())
  userId            String
  content           Json?
  assessmentId      String?
  postureAnalysisId String?
  createdAt         DateTime @default(now())

  // Relations
  user            User             @relation(fields: [userId], references: [id])
  assessment      Assessment?      @relation(fields: [assessmentId], references: [id])
  postureAnalysis PostureAnalysis? @relation(fields: [postureAnalysisId], references: [id])
  
  todos Todo[]
}

model Todo {
  id             String   @id @default(cuid())
  userId         String
  planId         String? // FK (optional)
  title          String
  completed      Boolean  @default(false)
  pointsPerCheck Int      @default(5)
  createdAt      DateTime @default(now())

  // relations
  user User  @relation(fields: [userId], references: [id])
  plan Plan? @relation(fields: [planId], references: [id])

  items ChecklistItem[]
}

model ChecklistItem {
  id          String    @id @default(cuid())
  todoId      String
  dayIndex    Int
  completed   Boolean   @default(false)
  completedAt DateTime?

  // relations
  todo Todo @relation(fields: [todoId], references: [id])

  @@index([todoId, dayIndex], map: "idx_todo_day")
}

model WeeklyReport {
  id        String   @id @default(cuid())
  userId    String
  weekStart DateTime
  summaryMd String?
  createdAt DateTime @default(now())

  // relations
  user User @relation(fields: [userId], references: [id])

  @@index([userId, weekStart])
}

model Reward {
  id        String   @id @default(cuid())
  userId    String
  points    Int
  kind      String
  threshold Int?
  note      String?
  createdAt DateTime @default(now())

  // relations
  user User @relation(fields: [userId], references: [id])

  @@index([userId, createdAt])
}

model CoachReport {
  id          String   @id @default(cuid())
  coachId     String   // Coach who uploaded the report
  studentId   String?  // Optional: if linked to a specific student
  title       String
  description String?
  
  // Student data (JSON format from student export)
  studentData Json     // Contains assessment results, posture analysis, etc.
  
  // GPT Analysis results
  gptAnalysis String?  // Professional analysis generated by GPT
  riskAnalysis String? // Risk assessment
  recommendations String? // Professional recommendations
  
  // Knowledge links
  knowledgeLinks Json?  // Array of knowledge links for coach learning
  
  // Status
  status      ReportStatus @default(PENDING)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // relations
  coach   User @relation("CoachReports", fields: [coachId], references: [id])
  student User? @relation("StudentReports", fields: [studentId], references: [id])

  @@index([coachId, createdAt])
  @@index([status])
}

model CoachStudent {
  id        String   @id @default(cuid())
  coachId   String
  studentId String
  createdAt DateTime @default(now())

  // relations
  coach   User @relation("CoachStudents", fields: [coachId], references: [id])
  student User @relation("StudentCoaches", fields: [studentId], references: [id])

  @@unique([coachId, studentId])
  @@index([coachId])
  @@index([studentId])
}


enum Constitution {
  BALANCED          
  QI_DEFICIENCY     
  YANG_DEFICIENCY   
  YIN_DEFICIENCY    
  PHLEGM_DAMPNESS   
  DAMP_HEAT         
  BLOOD_STASIS      
  QI_STAGNATION     
  SPECIAL          
}

enum Role {
  USER
  COACH
  ADMIN
}

enum ReportStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum CoachStatus {
  PENDING
  APPROVED
  REJECTED
}